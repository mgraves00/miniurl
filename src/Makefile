# $Id$
.SUFFIXES: .ort .h .sql .db
.PHONY: clean distclean regress distcheck

# https://github.com/kristapsdz/oconfigure compatibility.
# This is generated by ./configure.
.include "Makefile.configure"

DESTDIR=/tmp

SHARDIR=	/usr/local/share/examples
HTDOCS=		/usr/www/htdocs
HTURI=		/url
CGIBIN=		/var/www/cgi-bin
CGIURI=		/cgi-bin/miniurl
DATADIR=	/var/www/miniurl
RDDIR=		/minurl

# just objs that are common
OBJS	=	miniurl.o compats.o

ORTFILE =	miniurl.ort

HTMLS	=	index.html \
			edit.html \
			login.html \
			list.html \
			delete.html

CSSES	=	bulma.css \
			fontawesome.css

FONTS	=	fa-brands-400.ttf \
			fa-brands-400.woff2 \
			fa-regular-400.ttf \
			fa-regular-400.woff2 \
			fa-solid-900.ttf \
			fa-solid-900.woff2 \
			fa-v4compatibility.ttf \
			fa-v4compatibility.woff2

LICENSES=	LICENSE.bulma \
			LICENSE.fontawesome-free-6.2.1

LDADD_STATIC= -static
LD_PKG	!=	pkg-config --libs kcgi sqlbox 2>/dev/null
CF_PKG	!=	pkg-config --cflags kcgi sqlbox 2>/dev/null
LDADD	+=	${LD_PKG} -lpthread -L/usr/lib -lm -static
CFLAGS	+=	${CF_PKG} -I${.CURDIR}/obj -g


all: miniurl urluser miniurl.db

install: all
	mkdir -p ${DESTDIR}${CGIBIN}
	${INSTALL_PROGRAM} miniurl ${DESTDIR}${CGIBIN}
	mkdir -p ${DESTDIR}${DATADIR}
.for file in ${HTMLS}
	${INSTALL_DATA} content/${file} ${DESTDIR}${DATADIR}
.endfor
	mkdir -p ${DESTDIR}${DATADIR}/static
.for file in ${CSSES}
	${INSTALL_DATA} content/${file} ${DESTDIR}${DATADIR}/static
.endfor
	mkdir -p ${DESTDIR}${DATADIR}/webfonts
.for file in ${FONTS}
	${INSTALL_DATA} content/${file} ${DESTDIR}${DATADIR}/webfonts
.endfor
.for file in ${LICENSES}
	${INSTALL_DATA} content/${file} ${DESTDIR}${DATADIR}
.endfor
	${INSTALL_DATA} miniurl.db ${DESTDIR}${DATADIR}
	${INSTALL_PROGRAM} urluser ${DESTDIR}${DATADIR}
	mkdir -p ${DESTDIR}${SHARDIR}/miniurl
	${INSTALL_DATA} ${ORTFILE} ${DESTDIR}${SHARDIR}/miniurl
	${INSTALL_DATA} ../LICENSE ${DESTDIR}${SHARDIR}/miniurl
	${INSTALL_DATA} httpd.conf ${DESTDIR}${SHARDIR}/miniurl
	
uninstall:
	rm -f ${DESTDIR}${SHARDIR}/miniurl/LICENSE
	rm -f ${DESTDIR}${SHARDIR}/miniurl/httpd.conf
	rm -f ${DESTDIR}${SHARDIR}/miniurl/${ORTFILE}
	-rmdir ${DESTDIR}${SHARDIR}/miniurl
	rm -f ${DESTDIR}${DATADIR}/urluser
	rm -f ${DESTDIR}${DATADIR}/miniurl.db
.for file in ${LICENSES}
	rm -f ${DESTDIR}${DATADIR}/${file}
.endfor
.for file in ${FONTS}
	rm -f ${DESTDIR}${DATADIR}/webfonts/${file}
.endfor
	-rmdir ${DESTDIR}${DATADIR}/webfonts
.for file in ${CSSES}
	rm -f ${DESTDIR}${DATADIR}/static/${file}
.endfor
	-rmdir ${DESTDIR}${DATADIR}/static
.for file in ${HTMLS}
	rm -f ${DESTDIR}${DATADIR}/${file}
.endfor
	rm -f ${DESTDIR}${CGIBIN}/miniurl
	-rmdir ${DESTDIR}${DATADIR}
	-rmdir ${DESTDIR}${CGIBIN}


regress:
	# do nothing

distcheck:
	# do nothing

clean:
	rm -f miniurl.h miniurl.c miniurl.sql miniurl.db *.o
	rm -f miniurl urluser

distclean:
	rm -f config.log config.h Makeconfigure.configure

miniurl: ${OBJS} main.o
	${CC} ${LDADD_STATIC} -o ${.TARGET} ${LDFLAGS} ${LDADD} ${OBJS} main.o

urluser: ${OBJS} urluser.o
	${CC} ${LDADD_STATIC} -o ${.TARGET} ${LDFLAGS} ${LDADD} ${OBJS} urluser.o

miniurl.h: ${ORTFILE}
	ort-c-header -v ${ORTFILE} > ${.TARGET}

miniurl.c: ${ORTFILE} miniurl.h
	ort-c-source -v -h miniurl.h ${ORTFILE} > ${.TARGET}

miniurl.sql: miniurl.ort
	ort-sql miniurl.ort > ${DESTDIR}${.TARGET}

${OBJS}: miniurl.h

.sql.db:
	@rm -f ${DESTDIR}${.TARGET}
	sqlite3 ${DESTDIR}${.TARGET} < ${DESTDIR}${.IMPSRC}


